{% extends "base.html" %}

{% block title %}teoremer.com | search{% endblock %}

{% block mainbar %}

{% if pageuser %}
<h4>Items for user {{pageuser.get_full_name}}</h4>
{% endif %}

<div id="search-container">
{% include 'include/item_list.html' with itempage=itempage only %}
</div>

{% endblock %}

{% block sidebar %}

<h4>Type</h4>

<ul class="list-unstyled">
    <li><span class="glyphicon glyphicon-ok{% if links.type.all.changed %} transparent{% endif %}"></span>
        <a href="{{links.type.all.link}}">All</a></li>
    <li><span class="glyphicon glyphicon-ok{% if links.type.D.changed %} transparent{% endif %}"></span>
        <a href="{{links.type.D.link}}">Definitions</a></li>
    <li><span class="glyphicon glyphicon-ok{% if links.type.T.changed %} transparent{% endif %}"></span>
        <a href="{{links.type.T.link}}">Theorems</a></li>
    <li><span class="glyphicon glyphicon-ok{% if links.type.P.changed %} transparent{% endif %}"></span>
        <a href="{{links.type.P.link}}">Proofs</a></li>
</ul>

<h4>Status</h4>

<ul class="list-unstyled">
    <li><span class="glyphicon glyphicon-ok{% if links.status.F.changed %} transparent{% endif %}"></span>
        <a href="{{links.status.F.link}}">Published</a></li>
    <li><span class="glyphicon glyphicon-ok{% if links.status.R.changed %} transparent{% endif %}"></span>
        <a href="{{links.status.R.link}}">Under review</a></li>
{% if links.status.D %}
    <li><span class="glyphicon glyphicon-ok{% if links.status.D.changed %} transparent{% endif %}"></span>
        <a href="{{links.status.D.link}}">Drafts</a></li>
{% endif %}
</ul>

{% comment %}
<h4>Sorting</h4>

<ul class="list-unstyled">
    <li><span class="glyphicon glyphicon-ok"></span> Date</li>
    <li><span class="glyphicon glyphicon-ok transparent"></span> <a href="">Points</a></li>
</ul>
{% endcomment %}

{% endblock %}

{% block bodybottom %}
<script type="text/javascript">
(function ($container) {
    function add_to_query(url) {
        return url + (url.indexOf("?") < 0 ? "?" : "&") + "partial=true";
    }
    function init_load_handler($elem, direction) {
        if ($elem.attr('href')) {
            $elem.removeClass('hidden');
            $elem.click(function (event) {
                event.preventDefault();
                $elem.addClass('hidden');
                var data_url = add_to_query($elem.attr('href'));
                $.getJSON(data_url)
                    .done(function (data) {
                        if (direction === 'up') {
                            $container.find('ul').prepend(data.items);
                            data_url = data.prev_data_url;
                        } else {
                            $container.find('ul').append(data.items);
                            data_url = data.next_data_url;
                        }
                        $elem.attr('href', data_url);
                        if (data_url)
                            $elem.removeClass('hidden');
                    });
            });
        }
    }

    $container.find('a.prev-link').each(function () {
        init_load_handler($(this), 'up');
    });
    $container.find('a.next-link').each(function () {
        init_load_handler($(this), 'down');
    });

    var last_scroll = 0;
    $(window).scroll(function () {
        var scroll_pos = $(window).scrollTop();
        var window_height = $(window).height();
        var window_middle = scroll_pos + 0.5 * window_height;
        if (Math.abs(scroll_pos - last_scroll) > 0.1 * window_height) {
            last_scroll = scroll_pos;
            $container.find('.itempage').each(function (index) {
                var el_top = $(this).offset().top;
                var el_height = $(this).height();
                if (window_middle >= el_top && window_middle < el_top + el_height) {
                    history.replaceState(null, null, $(this).data("url"));
                    return(false);
                }
            });
        }
    });

})($('#search-container'));
</script>
{% endblock %}
