{% extends "base.html" %}
{% load staticfiles %}
{% load item_tags %}
{% load user_tags %}
{% load utils_tags %}

{% block title %}{{ item }}{% endblock %}

{% block mainbar %}

<div class="panel panel-default">
  <div class="panel-heading">
    <h4 class="panel-title">{{ item }}{% if item.parent %} of {{ item.parent }}{% endif %}</h4>
  </div>
  <div class="panel-body draft-view">
{{ item|typeset_body }}
  </div>
</div>

{% include 'items/include/categories.html' with categories=item.primary_categories no_categories_text="No primary categories" only %}

{% if validations %}
<h4 class="expander-in">{{ validations|length }} validation{{ validations|length|pluralize }} <span class="glyphicon"></span></h4>
<div id="validation-list"></div>
{% else %}
<h4>No validations</h4>
{% endif %}

{% endblock mainbar %}

{% block sidebar %}

<h4>Meta</h4>

<p>{{ item.get_status_display }}, latest edit by <a href="{% url 'users.views.profile' item.created_by.get_username %}">{{ item.created_by.get_full_name }}</a> at {{ item.modified_at|datetime_user:user }}</p>

<h4>Categories</h4>

{% include 'items/include/categories.html' with categories=item.secondary_categories no_categories_text="None" only %}

<h4>Actions</h4>

{% if perm.add_source %}
<p><a class="btn btn-primary" href="{% url 'sources.views.add_source_for_draft' item.id %}">Add source validation</a></p>
{% endif %}

{% if perm.edit %}
<p><a class="btn btn-primary" href="{% url 'drafts.views.edit' item.id %}">Edit</a></p>

<p><form method="post" action="{% url 'drafts.views.delete_draft' item.id %}">
  {% csrf_token %}
  <button class="btn btn-primary" type="submit">Delete</button>
</form></p>
{% endif %}

<!-- {% if perm.to_draft %}
<form method="post" action="{% url 'items.views.to_draft' item.id %}">
  {% csrf_token %}
  <button class="btn btn-primary" type="submit">Revert to draft</button>
</form>
{% endif %} -->

{% if perm.to_review %}
<p><form method="post" action="{% url 'drafts.views.to_review' item.id %}">
  {% csrf_token %}
  <button class="btn btn-primary" type="submit">Submit for review</button>
</form></p>
{% endif %}

{% if perm.to_final %}
<p><form method="post" action="{% url 'drafts.views.to_final' item.id %}">
  {% csrf_token %}
  <button class="btn btn-primary" type="submit">Publish</button>
</form></p>
{% endif %}

{% endblock %}

{% block bodybottom %}

{% include 'include/js-scripts.html' only %}

<script type="text/javascript">

  $(function() {
    $('div.draft-view').tooltip({
      selector: "a[rel=tooltip]"
    });    
  });

(function() {

  new teoremer.ValidationListView({
    el: $('#validation-list'),
    collection: new teoremer.ValidationList({{validations|to_json}})
  });

})();

</script>

{% endblock %}
